// OpenAIのライブラリをインポートします
const OpenAI = require('openai');

// Netlifyに設定するOpenAIのAPIキーを安全に読み込みます
const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY,
});

// Netlifyがこの関数を呼び出します
exports.handler = async function(event) {
    // POSTリクエスト以外は無視します
    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, body: 'Method Not Allowed' };
    }

    try {
        // フロントエンドから送られてきた肌スコアを受け取ります
        const { scores } = JSON.parse(event.body);
        
        [cite_start]// CSVから読み込んだ治療法データベースです [cite: 176]
        const treatmentsDB = `カテゴリ,治療法名,特徴,価格（円）
しわ,ボトックス,表情ジワの改善に即効性あり,20000
しわ,ヒアルロン酸注入,ボリュームアップに効果的,50000
しわ,PRP注入,自己血液を使った自然な再生治療,60000
しわ,スレッドリフト,引き上げ効果が高い,80000
しわ,マイクロニードルRF,皮膚深層への刺激でコラーゲン生成,70000
たるみ,HIFU,超音波で筋膜にアプローチ,90000
たるみ,スレッドリフト,糸による物理的なリフト,85000
たるみ,RF（高周波）,熱による皮膚の引き締め,60000
たるみ,ウルセラ,FDA認可のたるみ治療,120000
たるみ,サーマクール,高周波による深部加熱,100000
毛穴,フラクショナルCO2レーザー,レーザーで毛穴と皮膚再生を促進,40000
毛穴,ダーマペン,微細針でコラーゲン生成促進,30000
毛穴,ポテンツァ,微細針＋高周波で毛穴改善,80000
毛穴,ハイドラフェイシャル,毛穴と角質のディープクレンジング,20000
毛穴,カーボンピーリング,炭を用いたピーリングで引き締め,25000
赤み,IPL（フォトフェイシャル）,光による赤み・色ムラの改善,35000
赤み,Vビームレーザー,血管に特化した赤ら顔治療,45000
赤み,ロゼックスゲル,酒さ・赤ら顔に使用,3000
赤み,赤外線治療,赤外線で血行促進,15000
赤み,フラクショナルレーザー,赤みと同時に肌質も改善,60000
色素沈着,トラネキサム酸内服,肝斑・色素沈着に内服,5000
色素沈着,レーザートーニング,レーザーで均一な肌トーンに,30000
色素沈着,ハイドロキノン,メラニン抑制クリーム,4000
色素沈着,ルメッカ,しみやそばかすの改善,35000
色素沈着,ピコトーニング,肝斑に適した微弱レーザー,45000
肌質改善,エレクトロポレーション,成分導入による肌質改善,15000
肌質改善,マッサージピール,皮むけを伴うリフト＆美白,20000
肌質改善,プラズマ治療,殺菌・肌再生効果あり,40000
肌質改善,エクソソーム導入,幹細胞成分による肌修復,70000
肌質改善,水光注射,保湿と美容成分注入,30000
脂肪除去,脂肪溶解注射,脂肪細胞を直接分解,20000
脂肪除去,クールスカルプティング,冷却で脂肪細胞破壊,90000
脂肪除去,脂肪吸引,外科的な脂肪除去,300000
脂肪除去,HIFU（脂肪層）,脂肪層にピンポイント照射,100000
脂肪除去,カベリン注射,植物由来成分の脂肪融解,25000`;
        
        // ChatGPTへの指示書（プロンプト）です
        const userPrompt = `
# クライアントの肌診断スコア (100点満点)
- くすみ: ${scores.dullness}
- なめらかさ(しわ): ${scores.smoothness}
- ハリ(たるみ): ${scores.firmness}
- シミ: ${scores.spots}
- 毛穴: ${scores.pores}

# 提案可能な治療法リスト
${treatmentsDB}

# あなたへの指示
1. あなたは経験豊富な美容カウンセラーです。
2. 上記のクライアントの肌診断スコアを分析し、スコアが特に低い項目（目安：60点未満）を2つまで特定してください。
3. 特定した悩みに対して、治療法リストの中から最も関連性の高い治療法を2つずつ提案してください。
4. 提案する際は、「治療法名」「特徴」「参考価格」を分かりやすくまとめてください。価格には「円」を付けてください。
5. 全体を通して、専門的でありながらも、利用者に寄り添うような温かいトーンで記述してください。
6. 回答は必ずHTML形式で出力してください。診断結果のタイトルは<h3>タグ、各治療法の提案は<div>で囲み、治療法名は<h5>タグ、特徴と価格は<p>タグを使用してください。`;

        // ChatGPTにリクエストを送信します
        const completion = await openai.chat.completions.create({
            model: "gpt-3.5-turbo",
            messages: [
                {
                    role: "system",
                    content: "あなたは優秀な美容カウンセラーです。"
                },
                {
                    role: "user",
                    content: userPrompt
                }
            ],
        });

        const aiReportHtml = completion.choices[0].message.content;

        // フロントエンドにHTML形式のレポートを返します
        return {
            statusCode: 200,
            body: JSON.stringify({ report: aiReportHtml }),
        };
    } catch (error) {
        console.error("AI report generation failed:", error);
        // エラーが発生した場合は、エラーメッセージを返します
        return {
            statusCode: 500,
            body: JSON.stringify({ report: "<h3>エラー</h3><p>AIレポートの生成に失敗しました。APIキーや設定を確認してください。</p>" }),
        };
    }
};